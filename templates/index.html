<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""/>

        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
        <title>Boby</title>
    </head>
    <body>
        <h1>Mapa de la misión</h1>
        <p>No te diviertas</p>
        <div id="map" style="width:900px; height:500px"></div>

        <script>
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            var map = L.map('map').setView([40.453010, -3.732698], 15);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 24,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: ''
            }).addTo(map);
            
            
            
            //mapMarkers = []
            //lines = []
            //pol = []
            //homes = []
            var mapMarkers;
            var lines;
            var pol;
            var homes;
            
            //var prevPos = Array(20).fill([0,0,0]);


            var sourceSetup = new EventSource('/topic/mapaDronesSetup');
            sourceSetup.addEventListener('message', function(e) {

                obj = JSON.parse(e.data);
                console.log(obj);

                console.log(pol?.length || 0)

                if(obj.type === "setup") {
                    //Clean what was before
                    for(var i = 0; i < mapMarkers?.length || 0; i++){
                        map.removeLayer(mapMarkers[i]);
                    }
                    for(var i = 0; i < lines?.length || 0; i++){
                        map.removeLayer(lines[i]);
                    }
                    for(var i = 0; i < pol?.length || 0; i++){
                        map.removeLayer(pol[i]);
                    }
                    for(var i = 0; i < homes?.length || 0; i++){
                        map.removeLayer(homes[i]);
                    }

                    mapMarkers = []
                    lines = []
                    pol = []
                    homes = []


                    obj = JSON.parse(e.data);
                    console.log(obj);

                    var homeLat = obj.homeLat;
                    var homeLon = obj.homeLon;
                    //var homeAlt = obj.homeAlt;
                    var prevPos = Array(obj.numDrones).fill([homeLat,homeLon]);
                    
                    var pol = obj.pol;
                    L.polygon(pol, {color: 'red'}).addTo(map);
                    pol.push(pol)

                    homeMarker = L.marker([homeLat, homeLon], {icon: blackIcon}).addTo(map);
                    homes.push(homeMarker);
                } else if(obj.type === "end") {
                    //Print simulation results below the map
                }
            })

            var greenIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var goldIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var blackIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var source = new EventSource('/topic/mapaDronesTest');
            source.addEventListener('message', function(e) {

                obj = JSON.parse(e.data);
                console.log(obj);
                
                if(mapMarkers[parseInt(obj.id)] != null) {
                    map.removeLayer(mapMarkers[parseInt(obj.id)]);
                }
                if(obj.battery >= 75) {
                    newMarker = L.marker([obj.latitude, obj.longitude], {icon: greenIcon}).addTo(map);
                } else if (obj.battery >= 50 && obj.battery < 75) {
                    newMarker = L.marker([obj.latitude, obj.longitude], {icon: goldIcon}).addTo(map);
                } else {
                    newMarker = L.marker([obj.latitude, obj.longitude], {icon: redIcon}).addTo(map);
                }
                mapMarkers[parseInt(obj.id)] = newMarker;
                
                pathCoords = connectTheDots(prevPos[obj.id][0], prevPos[obj.id][1], obj.latitude, obj.longitude)

                var polyline = new L.Polyline(pathCoords, {
                    color: colorGradient(obj.normalizedSpeed, lowColor, mediumColor, highColor),
                    weight: 5,
                    smoothFactor: 1
                }).addTo(map);
                lines.push(polyline);
                
                prevPos[obj.id] = [obj.latitude, obj.longitude, obj.altitude];

                
            })
            /*
            var source = new EventSource('/video');
            source.addEventListener('message', function(e) {

                obj = JSON.parse(e.data);
                console.log(obj);
                var img = document.createElement("img");
                var frame = document.getElementById("video");
                frame.appendChild(obj.frame);
            })
            */
            
            function connectTheDots(lat1, lon1, lat2, lon2){
                var c = [];
                c.push([lat1, lon1]);
                c.push([lat2, lon2]);
                return c;
            }

            let lowColor = {
                red: 217,
                green: 83,
                blue: 79
            };
            let mediumColor = {
                red: 240,
                green: 173,
                blue: 78
            };
            let highColor = {
                red: 92,
                green: 184,
                blue: 91
            };
            function colorGradient(fadeFraction, rgbColor1, rgbColor2, rgbColor3) {
                var color1 = rgbColor1;
                var color2 = rgbColor2;
                var fade = fadeFraction;

                // Do we have 3 colors for the gradient? Need to adjust the params.
                if (rgbColor3) {
                fade = fade * 2;

                // Find which interval to use and adjust the fade percentage
                if (fade >= 1) {
                    fade -= 1;
                    color1 = rgbColor2;
                    color2 = rgbColor3;
                }
                }

                var diffRed = color2.red - color1.red;
                var diffGreen = color2.green - color1.green;
                var diffBlue = color2.blue - color1.blue;

                var gradient = {
                red: parseInt(Math.floor(color1.red + (diffRed * fade)), 10),
                green: parseInt(Math.floor(color1.green + (diffGreen * fade)), 10),
                blue: parseInt(Math.floor(color1.blue + (diffBlue * fade)), 10),
                };

                return 'rgb(' + gradient.red + ',' + gradient.green + ',' + gradient.blue + ')';
            }
        </script>
    </body>
</html>